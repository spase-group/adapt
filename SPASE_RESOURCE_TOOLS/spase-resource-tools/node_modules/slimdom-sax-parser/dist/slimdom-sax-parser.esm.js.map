{"version":3,"file":"slimdom-sax-parser.esm.js","sources":["../src/options.ts","../src/createNamespaceContext.ts","../src/createPositionTracker.ts","../src/parseDoctypeDeclaration.ts","../src/createHandler.ts","../src/asynchronouslyParseSlimdomDocument.ts","../src/synchronouslyParseSlimdomDocument.ts","../src/index.ts"],"sourcesContent":["import * as saxes from 'saxes';\n\nexport interface Options extends saxes.SaxesOptions {\n\tadditionalEntities?: {\n\t\t[entityName: string]: string;\n\t};\n}\n\nexport const DEFAULT_OPTIONS: Options = {\n\txmlns: true,\n\tposition: false,\n\tadditionalEntities: {}\n};\n","export const DEFAULT_NAMESPACES: Record<string, string | null> = {\n\t'': null,\n\n\t// Two namespace prefixes that are predetermined by the XML spec.\n\t//\n\t// See also:\n\t//   https://www.w3.org/TR/xml-names/#ns-decl\n\txml: 'http://www.w3.org/XML/1998/namespace',\n\txmlns: 'http://www.w3.org/2000/xmlns/'\n};\n\n/**\n * Records an array of overlapping objects that is shifted and unshifted as the parser traverses.\n */\nexport default function createNamespaceContext(additionalNsMapping: Record<string, string>) {\n\tconst namespaces: Record<string, string | null>[] = [DEFAULT_NAMESPACES];\n\tif (additionalNsMapping !== undefined) {\n\t\tnamespaces.unshift(additionalNsMapping);\n\t}\n\n\treturn {\n\t\t// pop and push are actually shift and unshift to make searches more efficient\n\t\tpush: (x: Record<string, string>) => namespaces.unshift(x),\n\n\t\tpop: () => namespaces.shift(),\n\n\t\t// Get the location associated with a prefix\n\t\tlocation: (prefix: string | undefined): string | null | undefined =>\n\t\t\tprefix === undefined\n\t\t\t\t? prefix\n\t\t\t\t: namespaces.find(ns => ns[prefix] !== undefined)?.[prefix]\n\t};\n}\n","import { SaxesParser } from 'saxes';\nimport { Attr, Node } from 'slimdom';\n\n/**\n * The helper functions to track node positions.\n */\ntype PositionTracker = {\n\ttrackNodePosition<N extends Node>(node: N): PositionTrackedNode<N>;\n\ttrackNodeClosePosition<N extends Node>(node: PositionTrackedNode<N>): PositionTrackedElement<N>;\n\tupdateLastTrackedPosition(): void;\n\tgetCurrentPosition(): Position;\n\ttrackAttributePosition<A extends Attr>(attr: A, endPosition: Position): PositionTrackedAttr<A>;\n};\n\n/**\n * One (collapsed) location in code. `offset` is equal to the length of all preceding lines + column.\n */\nexport type Position = {\n\toffset: number;\n\tline: number;\n\tcolumn: number;\n};\n\n/**\n * A location in code, possibly spanning text. `start` and `end` are both offsets from the start of\n * the XML source.\n */\nexport type PositionRange = {\n\tline: number;\n\tcolumn: number;\n\tstart: number;\n\tend: number;\n};\n\n/**\n * Various properties on nodes that contain the position information.\n */\nexport type PositionTrackedNode<N> = N & {\n\tposition: PositionRange;\n};\nexport type PositionTrackedElement<N> = PositionTrackedNode<N> & {\n\tclosePosition: PositionRange;\n};\nexport type PositionTrackedAttr<A> = A & {\n\tposition: {\n\t\tend: number;\n\t};\n};\n\n/**\n * The DOM node types enumeration. Only TEXT_NODE and COMMENT_NODE are used, so the rest is commented out.\n *\n * See also:\n *   https://developer.mozilla.org/en-US/docs/Web/API/Node/nodeType\n */\nconst types = {\n\t// ELEMENT_NODE: 1,\n\t// ATTRIBUTE_NODE: 2,\n\tTEXT_NODE: 3,\n\t// CDATA_SECTION_NODE: 4,\n\t// ENTITY_REFERENCE_NODE: 5,\n\t// ENTITY_NODE: 6,\n\t// PROCESSING_INSTRUCTION_NODE: 7,\n\tCOMMENT_NODE: 8\n\t// DOCUMENT_NODE: 9,\n\t// DOCUMENT_TYPE_NODE: 10,\n\t// DOCUMENT_FRAGMENT_NODE: 11,\n\t// NOTATION_NODE: 12\n};\n\n/**\n * Create the context needed to track the positions in an XML string at which a Slimdom node was defined. Is based on\n * input from the saxes parser and fixes some unexpected behaviour by it.\n */\nexport default function createPositionTracker(parser: SaxesParser): PositionTracker {\n\tlet lastTrackedPosition = {\n\t\t// Line and column numbers are 1-based\n\t\tline: 1,\n\t\tcolumn: 1,\n\n\t\t// Offset (start + end) are 0-based\n\t\toffset: 0\n\t};\n\n\tfunction updateLastTrackedPosition(): void {\n\t\tlastTrackedPosition = getCurrentPosition();\n\t}\n\n\t// Fixes some quirky results from saxes' position tracking:\n\t// - XML comments were always one character short\n\tfunction getCurrentPosition<N extends Node>(node?: N) {\n\t\tconst position = {\n\t\t\toffset: parser.position,\n\t\t\tline: parser.line,\n\t\t\tcolumn: parser.column + 1\n\t\t};\n\n\t\tif (!node) {\n\t\t\treturn position;\n\t\t}\n\n\t\tif (node.nodeType === types.TEXT_NODE) {\n\t\t\t// For XML text nodes the position tracking is always received when the next node is instantiated, eg.\n\t\t\t// the opening tag of the next sibling element or closing tag would show up in the text substr.\n\t\t\t// Therefore fix endPosition by not counting the next element or closing tag.\n\t\t\tposition.offset--;\n\t\t\tposition.column--;\n\t\t} else if (node.nodeType === types.COMMENT_NODE) {\n\t\t\t// For XML comments the position tracking is always received one character too short.\n\t\t\t// This right here is a local fix, and rather crude.\n\t\t\tposition.offset++;\n\t\t\tposition.column++;\n\t\t}\n\n\t\treturn position;\n\t}\n\n\t// Updates the tracker with new input from the saxes parser, and writes a \"position\" property to the DOM node\n\t// that was passed.\n\tfunction trackNodePosition<N extends Node>(node: N): PositionTrackedNode<N> {\n\t\tconst endPosition = getCurrentPosition(node);\n\n\t\t(node as PositionTrackedNode<N>).position = {\n\t\t\tline: lastTrackedPosition.line,\n\t\t\tcolumn: lastTrackedPosition.column,\n\t\t\tstart: lastTrackedPosition.offset,\n\t\t\tend: endPosition.offset\n\t\t};\n\n\t\tlastTrackedPosition = endPosition;\n\n\t\treturn node as PositionTrackedNode<N>;\n\t}\n\n\tfunction trackNodeClosePosition<N extends Node>(node: PositionTrackedNode<N>) {\n\t\tconst endPosition = getCurrentPosition(node);\n\n\t\t(node as PositionTrackedElement<N>).closePosition = {\n\t\t\tline: lastTrackedPosition.line,\n\t\t\tcolumn: lastTrackedPosition.column,\n\t\t\tstart: lastTrackedPosition.offset,\n\t\t\tend: endPosition.offset\n\t\t};\n\n\t\tlastTrackedPosition = endPosition;\n\n\t\treturn node as PositionTrackedElement<N>;\n\t}\n\n\tfunction trackAttributePosition<A extends Attr>(\n\t\tattr: A,\n\t\tendPosition: Position\n\t): PositionTrackedAttr<A> {\n\t\t(attr as PositionTrackedAttr<A>).position = {\n\t\t\tend: endPosition.offset\n\t\t};\n\n\t\treturn attr as PositionTrackedAttr<A>;\n\t}\n\n\treturn {\n\t\tgetCurrentPosition,\n\t\ttrackAttributePosition,\n\t\ttrackNodeClosePosition,\n\t\ttrackNodePosition,\n\t\tupdateLastTrackedPosition\n\t};\n}\n\n/**\n * No-op alternative for position tracking, when position tracking is disabled.\n */\nexport const positionTrackerStubs: PositionTracker = {\n\tgetCurrentPosition: () => ({ offset: 0, line: 0, column: 0 }),\n\ttrackAttributePosition: (attr?: any) => attr,\n\ttrackNodeClosePosition: (node?: any) => node,\n\ttrackNodePosition: (node?: any) => node,\n\tupdateLastTrackedPosition: () => {}\n};\n","/*\n * Split the doctype string\n * Thanks to https://github.com/jindw/xmldom\n */\nfunction splitDoctypeDeclaration(source: string, start = 0) {\n\tlet match;\n\tconst buf = [];\n\tconst reg = /'[^']+'|\"[^\"]+\"|[^\\s<>/=]+=?|(\\/?\\s*>|<)/g;\n\treg.lastIndex = start;\n\treg.exec(source); //skip <\n\twhile ((match = reg.exec(source))) {\n\t\tbuf.push(match[0]);\n\t\tif (match[1]) return buf;\n\t}\n\treturn buf;\n}\n\nexport function parseDoctypeDeclaration(source: string) {\n\tconst [\n\t\t// @ts-ignore TS6133\n\t\t// eslint-disable-next-line @typescript-eslint/no-unused-vars\n\t\t_opening,\n\t\tqualifiedName, // @ts-ignore TS6133\n\t\ttype,\n\t\tpublicIdOrSystemId,\n\t\tsystemId\n\t] = splitDoctypeDeclaration(source);\n\treturn type === 'PUBLIC'\n\t\t? {\n\t\t\t\tqualifiedName,\n\t\t\t\tpublicId: publicIdOrSystemId.replace(/^\"(.*)\"$/, '$1'),\n\t\t\t\tsystemId: systemId?.replace(/^\"(.*)\"$/, '$1') || null\n\t\t  }\n\t\t: {\n\t\t\t\tqualifiedName,\n\t\t\t\tpublicId: null,\n\t\t\t\tsystemId: publicIdOrSystemId.replace(/^\"(.*)\"$/, '$1')\n\t\t  };\n}\n","import {\n\tAttributeHandler,\n\tCDataHandler,\n\tCloseTagHandler,\n\tCommentHandler,\n\tDoctypeHandler,\n\tOpenTagHandler,\n\tOpenTagStartHandler,\n\tPIHandler,\n\tSaxesAttributeNS,\n\tSaxesOptions,\n\tSaxesParser,\n\tTextHandler\n} from 'saxes';\nimport { Document } from 'slimdom';\nimport createNamespaceContext from './createNamespaceContext';\nimport createPositionTracker, { Position, positionTrackerStubs } from './createPositionTracker';\nimport { parseDoctypeDeclaration } from './parseDoctypeDeclaration';\n\ntype Handler = {\n\tonText: TextHandler;\n\tonOpenTag: OpenTagHandler<SaxesOptions>;\n\tonOpenTagStart: OpenTagStartHandler<SaxesOptions>;\n\tonCloseTag: CloseTagHandler<SaxesOptions>;\n\tonAttribute: AttributeHandler<{ xmlns: true; position: true }>;\n\tonProcessingInstruction: PIHandler;\n\tonComment: CommentHandler;\n\tonDocType: DoctypeHandler;\n\tonCdata: CDataHandler;\n\tdocument: Document;\n};\n\n/*\n * Create the required callbacks for populating a new document from sax event handlers\n */\nexport default function createHandler(parser: SaxesParser, options: SaxesOptions): Handler {\n\t// A new XML DOM object that has the same API as the browser DOM implementation, but isomorphic and supports\n\t// namespaces.\n\tconst document = new Document();\n\n\t// The node into which new child nodes are inserted. Is rewritten as the handler traverses in and out of elements.\n\tlet contextNode: any = document;\n\n\t// Helpers for other responsibilities\n\tconst namespaces = createNamespaceContext(options.additionalNamespaces || {});\n\n\tconst {\n\t\ttrackNodePosition,\n\t\ttrackNodeClosePosition,\n\t\tupdateLastTrackedPosition,\n\t\tgetCurrentPosition,\n\t\ttrackAttributePosition\n\t} = options.position ? createPositionTracker(parser) : positionTrackerStubs;\n\n\tlet attributePositions: Map<string, Position> = new Map();\n\n\t// Return a bunch of methods that can be applied directly to a saxes parser instance.\n\treturn {\n\t\tonText: text => {\n\t\t\tif (contextNode === document) {\n\t\t\t\tupdateLastTrackedPosition();\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tconst textNode = trackNodePosition(document.createTextNode(text));\n\t\t\tcontextNode.appendChild(textNode);\n\t\t},\n\n\t\tonOpenTag: element => {\n\t\t\t// More namespace declarations might be applicable\n\t\t\tif (element.ns) {\n\t\t\t\tnamespaces.push(element.ns);\n\t\t\t}\n\t\t\tconst nsLocation = namespaces.location(element.prefix);\n\t\t\tif (nsLocation === undefined) {\n\t\t\t\tthrow new Error(`Could not resolve a namespace location for \"${element.prefix}\"`);\n\t\t\t}\n\t\t\tconst node = trackNodePosition(document.createElementNS(nsLocation, element.name));\n\n\t\t\tObject.keys(element.attributes)\n\t\t\t\t.map(name => element.attributes[name])\n\t\t\t\t.forEach((attr: string | SaxesAttributeNS) => {\n\t\t\t\t\tif (typeof attr === 'string') {\n\t\t\t\t\t\t// @TODO Find out why saxes sometimes uses strings instead of SaxesAttributeNs\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// Default namespace declarations do not apply to attributes, so if an attribute\n\t\t\t\t\t// is not prefixed the namespace location is null\n\t\t\t\t\tlet namespaceURI = attr.prefix === '' ? null : namespaces.location(attr.prefix);\n\n\t\t\t\t\t// @xmlns has no prefix but is in the XMLNS namespace\n\t\t\t\t\tif (attr.prefix === '' && attr.name === 'xmlns') {\n\t\t\t\t\t\tnamespaceURI = namespaces.location('xmlns');\n\t\t\t\t\t}\n\n\t\t\t\t\tconst position = attributePositions.get(attr.name)!;\n\t\t\t\t\tconst attributeNode = trackAttributePosition(\n\t\t\t\t\t\tdocument.createAttributeNS(namespaceURI!, attr.name),\n\t\t\t\t\t\tposition\n\t\t\t\t\t);\n\t\t\t\t\tattributeNode.value = attr.value;\n\t\t\t\t\tnode.setAttributeNode(attributeNode);\n\t\t\t\t});\n\n\t\t\tcontextNode.appendChild(node);\n\t\t\tcontextNode = node;\n\t\t},\n\n\t\tonOpenTagStart: () => {\n\t\t\tattributePositions = new Map();\n\t\t},\n\n\t\tonAttribute: attribute => {\n\t\t\tattributePositions.set(attribute.name, getCurrentPosition());\n\t\t},\n\n\t\tonCloseTag: () => {\n\t\t\t// Update position tracking so that the closing tag of an element is not prepended to the following sibling\n\t\t\ttrackNodeClosePosition(contextNode);\n\n\t\t\tif (!contextNode.parentNode) {\n\t\t\t\tthrow new Error('End of the line!');\n\t\t\t}\n\n\t\t\t// Any traversal from now on is within a higher context element\n\t\t\tcontextNode = contextNode.parentNode;\n\n\t\t\t// Less namespace declarations might now be applicable\n\t\t\tnamespaces.pop();\n\t\t},\n\n\t\tonProcessingInstruction: pi => {\n\t\t\tcontextNode.appendChild(\n\t\t\t\ttrackNodePosition(document.createProcessingInstruction(pi.target, pi.body))\n\t\t\t);\n\t\t},\n\n\t\tonComment: comment => {\n\t\t\tcontextNode.appendChild(trackNodePosition(document.createComment(comment)));\n\t\t},\n\n\t\tonDocType: data => {\n\t\t\tconst { qualifiedName, publicId, systemId } = parseDoctypeDeclaration(\n\t\t\t\t`<!DOCTYPE ${data}>`\n\t\t\t);\n\t\t\tcontextNode.appendChild(\n\t\t\t\ttrackNodePosition(\n\t\t\t\t\tdocument.implementation.createDocumentType(\n\t\t\t\t\t\tqualifiedName,\n\t\t\t\t\t\tpublicId || '',\n\t\t\t\t\t\tsystemId || ''\n\t\t\t\t\t)\n\t\t\t\t)\n\t\t\t);\n\t\t},\n\n\t\tonCdata: string => {\n\t\t\tcontextNode.appendChild(trackNodePosition(document.createCDATASection(string)));\n\t\t},\n\n\t\tdocument: document\n\t};\n}\n","import * as saxes from 'saxes';\nimport { DEFAULT_OPTIONS, Options } from './options';\nimport { Document } from 'slimdom';\nimport { Readable } from 'stream';\n\nimport createHandler from './createHandler';\n\n/**\n * Asynchronously parse a string or readable stream of XML to a Slimdom document.\n */\nexport function async(xml: string | Readable, options?: Options): Promise<Document> {\n\treturn new Promise((resolve, reject) => {\n\t\t// Set up the sax parser\n\t\tconst mergedOptions = { ...DEFAULT_OPTIONS, ...options };\n\t\tconst parser = new saxes.SaxesParser(mergedOptions);\n\t\tconst handler = createHandler(parser, mergedOptions);\n\n\t\t// Bind the handler functions to saxes events\n\t\tparser.on('attribute', handler.onAttribute);\n\t\tparser.on('cdata', handler.onCdata);\n\t\tparser.on('closetag', handler.onCloseTag);\n\t\tparser.on('comment', handler.onComment);\n\t\tparser.on('doctype', handler.onDocType);\n\t\tparser.on('error', error => {\n\t\t\treject(error);\n\t\t});\n\t\tparser.on('opentag', handler.onOpenTag);\n\t\tparser.on('opentagstart', handler.onOpenTagStart);\n\t\tparser.on('processinginstruction', handler.onProcessingInstruction);\n\t\tparser.on('text', handler.onText);\n\n\t\t// Handle additionalEntities\n\t\tif (options !== undefined && options.additionalEntities !== undefined) {\n\t\t\tfor (const [entity, entityValue] of Object.entries(options.additionalEntities)) {\n\t\t\t\tparser.ENTITIES[entity] = entityValue;\n\t\t\t}\n\t\t}\n\n\t\t// Take input from either a string argument...\n\t\tif (typeof xml === 'string') {\n\t\t\tparser.write(xml).close();\n\t\t\tresolve(handler.document);\n\t\t\treturn;\n\t\t}\n\n\t\t// Or take input from a readable string...\n\t\tif (xml instanceof Readable) {\n\t\t\txml.on('readable', () => {\n\t\t\t\tlet chunk;\n\t\t\t\twhile ((chunk = xml.read(xml.readableHighWaterMark || 8 * 1024))) {\n\t\t\t\t\tparser.write(chunk);\n\t\t\t\t}\n\t\t\t});\n\t\t\txml.on('end', () => {\n\t\t\t\tparser.close();\n\t\t\t\tresolve(handler.document);\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\t// Or throw on invalid input.\n\t\treject(new Error(`Unsupported input type ${typeof xml}.`));\n\t});\n}\n","import * as saxes from 'saxes';\nimport { DEFAULT_OPTIONS, Options } from './options';\n\nimport createHandler from './createHandler';\n\n/**\n * Synchronously parse a string of XML to a Slimdom document.\n */\nexport function sync(xml: string, options?: Options) {\n\t// Set up the sax parser\n\tconst mergedOptions = { ...DEFAULT_OPTIONS, ...options };\n\tconst parser = new saxes.SaxesParser(mergedOptions);\n\tconst handler = createHandler(parser, mergedOptions);\n\n\t// Bind the handler functions to saxes events\n\tparser.on('attribute', handler.onAttribute);\n\tparser.on('cdata', handler.onCdata);\n\tparser.on('closetag', handler.onCloseTag);\n\tparser.on('comment', handler.onComment);\n\tparser.on('doctype', handler.onDocType);\n\tparser.on('opentag', handler.onOpenTag);\n\tparser.on('opentagstart', handler.onOpenTagStart);\n\tparser.on('processinginstruction', handler.onProcessingInstruction);\n\tparser.on('text', handler.onText);\n\n\t// Handle additionalEntities\n\tif (options !== undefined && options.additionalEntities !== undefined) {\n\t\tfor (const [entity, entityValue] of Object.entries(options.additionalEntities)) {\n\t\t\tparser.ENTITIES[entity] = entityValue;\n\t\t}\n\t}\n\n\tparser.write(xml).close();\n\n\treturn handler.document;\n}\n","// Workaround for `export * as slimdom`, which doesn't work well in some TS versions\nimport * as _slimdom from 'slimdom';\nexport const slimdom = _slimdom;\n\nexport { Options, DEFAULT_OPTIONS } from './options';\nexport { DEFAULT_NAMESPACES } from './createNamespaceContext';\nexport { async } from './asynchronouslyParseSlimdomDocument';\nexport { sync } from './synchronouslyParseSlimdomDocument';\n"],"names":["DEFAULT_OPTIONS","xmlns","position","additionalEntities","DEFAULT_NAMESPACES","xml","createNamespaceContext","additionalNsMapping","namespaces","undefined","unshift","push","x","pop","shift","location","prefix","find","ns","types","TEXT_NODE","COMMENT_NODE","createPositionTracker","parser","lastTrackedPosition","line","column","offset","updateLastTrackedPosition","getCurrentPosition","node","nodeType","trackNodePosition","endPosition","start","end","trackNodeClosePosition","closePosition","trackAttributePosition","attr","positionTrackerStubs","splitDoctypeDeclaration","source","match","buf","reg","lastIndex","exec","parseDoctypeDeclaration","qualifiedName","type","publicIdOrSystemId","systemId","publicId","replace","createHandler","options","document","Document","contextNode","additionalNamespaces","attributePositions","Map","onText","text","textNode","createTextNode","appendChild","onOpenTag","element","nsLocation","Error","createElementNS","name","Object","keys","attributes","map","forEach","namespaceURI","get","attributeNode","createAttributeNS","value","setAttributeNode","onOpenTagStart","onAttribute","attribute","set","onCloseTag","parentNode","onProcessingInstruction","pi","createProcessingInstruction","target","body","onComment","comment","createComment","onDocType","data","implementation","createDocumentType","onCdata","string","createCDATASection","async","Promise","resolve","reject","mergedOptions","saxes","handler","on","error","entries","entity","entityValue","ENTITIES","write","close","Readable","chunk","read","readableHighWaterMark","sync","slimdom","_slimdom"],"mappings":"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"}